<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buat Nota Sewu Laundry</title>
  <!-- Tambah Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Courier New', monospace; background: #f4f4f4; padding: 20px; max-width: 500px; margin: auto; }
    .form { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    button { background: #25D366; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 20px; }
    button:hover { background: #128C7E; }
    .nota-preview { background: #fff; padding: 15px; border: 2px dashed #000; margin-top: 20px; white-space: pre; font-size: 14px; display: none; }

    .history { margin-top: 40px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .history h3 { margin: 0 0 15px; text-align: center; }
    .history-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; }
    .history-item:hover { background: #f0f0f0; }

    .btn-laporan { background: #FFB800 !important; color: #000 !important; font-weight: bold; margin-top: 20px; }
    .btn-laporan:hover { background: #e6a600 !important; }

    .logout { background: #e74c3c; margin-top: 20px; }
    .logout:hover { background: #c0392b; }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 420px; }
    .close { float: right; font-size: 30px; font-weight: bold; cursor: pointer; color: #aaa; }
    .close:hover { color: #000; }
    .btn-small { padding: 10px 16px; margin: 8px 5px 0; font-size: 14px; border-radius: 6px; cursor: pointer; }
    .btn-red { background: #e74c3c; }
    .btn-red:hover { background: #c0392b; }
  </style>
</head>
<body>

<div class="form">
  <h2 style="text-align:center;">Sewu Laundry by Kostory</h2>
  <p style="text-align:center;">Buat Nota Digital</p>
  <p style="text-align:center; margin-bottom:20px;">Selamat datang, <b><span id="userDisplay"></span></b> 
    <button class="logout" style="padding:8px 15px; font-size:14px; width:auto; margin-left:10px;" onclick="keluar()">Keluar</button>
  </p>

  <!-- NAMA PELANGGAN (bisa ketik atau pilih dari database) -->
  <label>Nama Konsumen</label>
  <input type="text" id="nama" list="daftarPelanggan" placeholder="Ketik atau pilih nama" autocomplete="off" required />
  <datalist id="daftarPelanggan"></datalist>

  <!-- NO HP (otomatis terisi saat nama dipilih) -->
  <label>No. HP Konsumen (WhatsApp)</label>
  <input type="text" id="nohp" placeholder="628123456789 (tanpa +)" required />

  <label>Kasir (Pilih Nama Kostory)</label>
  <select id="kasir" required>
    <option value="Mekar">Mekar</option>
    <option value="Satria">Satria</option>
    <option value="Mitraya">Mitraya</option>
    <option value="Mitra">Mitra</option>
    <option value="Ecokost">Ecokost</option>
    <option value="Bukit">Bukit</option>
    <option value="Kanaya">Kanaya</option>
  </select>

  <label>Berat (kg)</label>
  <input type="number" id="berat" min="1" value="8" required />

  <label>Harga per kg</label>
  <input type="number" id="harga" value="7500" required />

  <label>Jenis Pewangi</label>
  <select id="pewangi">
    <option value="Pxl">Pxl</option>
    <option value="Mxl">Mxl</option>
    <option value="Downy">Downy</option>
    <option value="Molto">Molto</option>
  </select>

  <label>Diskon (opsional)</label>
  <input type="number" id="diskon" value="0" />

  <button onclick="buatNota()">Buat Nota & Kirim WhatsApp</button>

  <pre class="nota-preview" id="preview"></pre>
</div>

<div class="history">
  <h3>Riwayat Transaksi (2 Bulan Terakhir)</h3>
  <div id="historyList"></div>
  <button class="btn-laporan" onclick="cetakLaporanBulanLalu()">Cetak Laporan Bulan Lalu</button>
</div>

<!-- Modal Update -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">×</span>
    <h3>Update Status Transaksi</h3>
    <p><strong>No Nota:</strong> <span id="modalNota"></span></p>
    <p><strong>Nama:</strong> <span id="modalNama"></span></p>

    <label>Status Pembayaran</label>
    <select id="modalStatus">
      <option value="Belum Lunas">Belum Lunas</option>
      <option value="Lunas">Lunas</option>
    </select>

    <label>Tanggal Pelunasan</label>
    <input type="date" id="modalLunas" />

    <label>Tanggal Diambil</label>
    <input type="date" id="modalAmbil" />

    <div style="text-align:center; margin-top:20px;">
      <button class="btn-small" onclick="updateTransaksi()">Update</button>
      <button class="btn-small" onclick="shareTransaksi()">Share via WA</button>
      <button class="btn-small btn-red" onclick="hapusTransaksi()">Hapus</button>
    </div>
  </div>
</div>

<script>
// Firebase Config & Init
const firebaseConfig = {
  apiKey: "AIzaSyCpTPqfkOCBv5_kMHtvtYjoGLfk3cDNuQ4",
  authDomain: "laundry-kostory.firebaseapp.com",
  databaseURL: "https://laundry-kostory-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laundry-kostory",
  storageBucket: "laundry-kostory.firebasestorage.app",
  messagingSenderId: "264559624850",
  appId: "1:264559624850:web:f1a9ce75036bcffa4f5c4b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const loggedUser = localStorage.getItem("loggedUser");
if (!loggedUser) window.location.href = "index.html";
document.getElementById("userDisplay").textContent = loggedUser === "admin" ? "ADMIN" : loggedUser.toUpperCase();

function keluar() {
  localStorage.removeItem("loggedUser");
  window.location.href = "index.html";
}

// Sync Pelanggan ke Firebase (ganti localStorage)
const DB_PELANGGAN = "pelanggan";

function simpanPelanggan(nama, nohp) {
  db.ref(DB_PELANGGAN + '/' + nama.toLowerCase()).set(nohp);
}

function isiDatalistPelanggan() {
  db.ref(DB_PELANGGAN).on("value", snap => {
    const db = snap.val() || {};
    const datalist = document.getElementById("daftarPelanggan");
    datalist.innerHTML = "";
    for (let nama in db) {
      const option = document.createElement("option");
      option.value = nama.charAt(0).toUpperCase() + nama.slice(1);
      datalist.appendChild(option);
    }
  });
}

// Saat nama input → isi nohp otomatis dari Firebase
document.getElementById("nama").addEventListener("input", function() {
  const nama = this.value.trim().toLowerCase();
  db.ref(DB_PELANGGAN + '/' + nama).once("value").then(snap => {
    const nohp = snap.val();
    if (nohp) document.getElementById("nohp").value = nohp;
  });
});

// Sync History ke Firebase (ganti localStorage)
function perbaikiDataLama() {
  // Perbaikan data lama dilewatkan karena data sekarang di Firebase
}

function formatRupiah(angka){
  return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
}

function getNomorUrutHariIni() {
  const today = new Date().toISOString().slice(0,10);
  const key = "laundry_urut_" + today;
  let urut = parseInt(localStorage.getItem(key) || "0") + 1;
  localStorage.setItem(key, urut);
  return String(urut).padStart(2, '0');
}

function simpanTransaksi(data) {
  db.ref("sewu_history").push(data);
}

function formatTanggalRingkas(date) {
  const bulan = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  return `${date.getDate()} ${bulan[date.getMonth()]} ${String(date.getFullYear()).slice(2)}`;
}

let currentEditIndex = null;

function buatNota(){
  const namaInput = document.getElementById('nama').value.trim();
  if (!namaInput) { alert("Nama konsumen wajib diisi!"); return; }
  const nama = namaInput || "Pelanggan";
  const nohp = document.getElementById('nohp').value.trim();
  if (!nohp) { alert("Nomor HP wajib diisi!"); return; }

  // SIMPAN KE DATABASE PELANGGAN (otomatis)
  simpanPelanggan(nama, nohp);
  // isiDatalistPelanggan dipanggil auto via on value

  const kasir = document.getElementById('kasir').value;
  const berat = parseFloat(document.getElementById('berat').value);
  const harga = parseFloat(document.getElementById('harga').value);
  const pewangi = document.getElementById('pewangi').value;
  const diskon = parseFloat(document.getElementById('diskon').value) || 0;

  const subtotal = berat * harga;
  const total = subtotal - diskon;

  const sekarang = new Date();
  const selesai = new Date(sekarang);
  selesai.setDate(selesai.getDate() + 3);

  const formatTgl = (d) => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} - ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;

  const bln = String(sekarang.getMonth() + 1).padStart(2, '0');
  const tgl = String(sekarang.getDate()).padStart(2, '0');
  const urut = getNomorUrutHariIni();
  const notaOtomatis = bln + tgl + urut;

  const teksNota = `Sewu Laundry by Kostory
====================
Tanggal : ${formatTgl(sekarang)}
No Nota : ${notaOtomatis}
Kostory   : ${kasir}                                               
Nama    : ${nama.toLowerCase()}
===================

Tipe Laundry : Kg Reguler
Tipe Layanan : Cuci + Setrika
Jenis Pewangi : ${pewangi}
Berat (kg) = ${berat}
Harga /kg = ${formatRupiah(harga)}

Subtotal = ${formatRupiah(subtotal)}
Diskon   = ${formatRupiah(diskon)}
Bayar    = ${formatRupiah(total)}

====================
Perkiraan Selesai : 
${formatTgl(selesai)}
====================
Status : ${total > 0 ? "Belum lunas" : "Lunas"}
Dilunasi : -
Diambil  : -
====================
KETENTUAN :
1. 1 Order 1 Mesin, Pakaian Luntur bukan menjadi tanggung jawab laundry, untuk menghindari luntur, ambil paket satuan.
2. Komplain pakaian kami layani 1x24 jam, sejak pakaian diantar.
3. Laundry akan diantar didepan kamar, yang tidak masukan kamar jangka waktu 3 hari akan disimpan digudang, jika terjadi kerusakan menjadi tanggung jawab pemilik.
4. Kompensasi maksimal Rp100.000,- (seratus ribu rupiah)

====================`;

  const transaksi = {
    nota: notaOtomatis,
    tanggal: sekarang.toISOString(),
    nama: nama,
    total: total,
    status: total > 0 ? "Belum Lunas" : "Lunas",
    kasir: kasir,
    lunas: "",
    ambil: "",
    teksNota: teksNota,
    nohp: nohp
  };

  simpanTransaksi(transaksi);

  document.getElementById('preview').textContent = teksNota;
  document.getElementById('preview').style.display = 'block';
  window.open(`https://wa.me/${nohp}?text=${encodeURIComponent(teksNota)}`, '_blank');
}

// Filter history berdasarkan kasir (kecuali admin) – dari Firebase
function tampilkanHistory() {
  const ref = db.ref("sewu_history");
  ref.on("value", snap => {
    let history = snap.val() || {};
    history = Object.keys(history).map(key => ({...history[key], key}));

    const sekarang = new Date();
    const duaBulanLalu = new Date(sekarang.getFullYear(), sekarang.getMonth() - 2, sekarang.getDate());

    history = history.filter(t => new Date(t.tanggal) >= duaBulanLalu);

    // Filter hanya milik sendiri kalau bukan admin
    if (loggedUser !== "admin") {
      history = history.filter(t => t.kasir && t.kasir.toLowerCase() === loggedUser);
    }

    const list = document.getElementById("historyList");
    if (history.length === 0) {
      list.innerHTML = "<p style='text-align:center; color:#999;'>Belum ada transaksi</p>";
      return;
    }

    list.innerHTML = "";
    history.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal));

    history.forEach((t, i) => {
      const item = document.createElement("div");
      item.className = "history-item";
      item.innerHTML = `${formatTanggalRingkas(new Date(t.tanggal))} | ${t.nama} | ${formatRupiah(t.total)} | ${t.status}`;
      item.onclick = () => bukaModal(t.key, t); // Pakai key Firebase
      list.appendChild(item);
    });
  });
}

// Laporan Bulan Lalu dari Firebase (hanya admin)
function cetakLaporanBulanLalu() {
  if (loggedUser !== "admin") {
    alert("Hanya Admin yang bisa mencetak laporan bulanan.");
    return;
  }

  db.ref("sewu_history").once("value").then(snap => {
    let history = snap.val() || {};
    history = Object.keys(history).map(key => ({...history[key], key}));

    const sekarang = new Date();
    const bulanLalu = new Date(sekarang.getFullYear(), sekarang.getMonth() - 1, 1);
    const akhirBulanLalu = new Date(sekarang.getFullYear(), sekarang.getMonth(), 0);

    const transaksiBulanLalu = history.filter(t => {
      const tgl = new Date(t.tanggal);
      return tgl >= bulanLalu && tgl <= akhirBulanLalu;
    });

    if (transaksiBulanLalu.length === 0) {
      alert("Belum ada transaksi di bulan lalu.");
      return;
    }

    const namaBulan = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
    const bulanNama = namaBulan[akhirBulanLalu.getMonth()];
    const tahun = akhirBulanLalu.getFullYear();

    let totalPendapatan = 0;
    let lunas = 0;
    let belumLunas = 0;

    let tabel = transaksiBulanLalu.map(t => {
      totalPendapatan += t.total;
      if (t.status === "Lunas") lunas++; else belumLunas++;
      return `<tr>
        <td style="padding:8px; border-bottom:1px solid #ddd;">${t.nota}</td>
        <td style="padding:8px; border-bottom:1px solid #ddd;">${formatTanggalRingkas(new Date(t.tanggal))}</td>
        <td style="padding:8px; border-bottom:1px solid #ddd;">${t.nama}</td>
        <td style="padding:8px; border-bottom:1px solid #ddd; text-align:right;">${formatRupiah(t.total)}</td>
        <td style="padding:8px; border-bottom:1px solid #ddd;">${t.status}</td>
      </tr>`;
    }).join("");

    const htmlLaporan = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Laporan Bulan ${bulanNama} ${tahun}</title>
    <style>body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { color: #25D366; margin: 0; }
    .header p { color: #555; margin: 5px 0; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
    th { background: #25D366; color: white; padding: 12px; }
    .summary { margin: 30px 0; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .summary h2 { margin-top: 0; color: #25D366; }
    .total { font-size: 24px; font-weight: bold; color: #25D366; }
    @media print { body { background: white; } .no-print { display: none; } }
    </style></head><body>
    <div class="header"><h1>Sewu Laundry by Kostory</h1><p>Laporan Bulan <strong>${bulanNama} ${tahun}</strong></p></div>
    <table><thead><tr><th>No Nota</th><th>Tanggal</th><th>Nama</th><th>Jumlah</th><th>Status</th></tr></thead><tbody>${tabel}</tbody></table>
    <div class="summary"><h2>Ringkasan Bulan ${bulanNama} ${tahun}</h2>
    <p>Total Transaksi: <strong>${transaksiBulanLalu.length}</strong></p>
    <p>Lunas: <strong>${lunas}</strong> | Belum Lunas: <strong>${belumLunas}</strong></p>
    <p class="total">Total Pendapatan: ${formatRupiah(totalPendapatan)}</p></div>
    <div style="text-align:center; margin-top:40px;" class="no-print">
      <button onclick="window.print()" style="padding:12px 30px; background:#25D366; color:white; border:none; border-radius:8px; font-size:16px; cursor:pointer;">
        Cetak / Simpan PDF
      </button>
    </div></body></html>`;

    const win = window.open("", "_blank");
    win.document.write(htmlLaporan);
    win.document.close();
  });
}

// Modal & fungsi lain – pakai Firebase key
function bukaModal(key, data) {
  currentEditIndex = key; // Ganti index dengan key Firebase
  document.getElementById("modalNota").textContent = data.nota;
  document.getElementById("modalNama").textContent = data.nama;
  document.getElementById("modalStatus").value = data.status || "Belum Lunas";
  document.getElementById("modalLunas").value = data.lunas || "";
  document.getElementById("modalAmbil").value = data.ambil || "";
  document.getElementById("editModal").style.display = "flex";
}

function closeModal() {
  document.getElementById("editModal").style.display = "none";
  currentEditIndex = null;
}

function updateTransaksi() {
  if (currentEditIndex === null) return;
  db.ref("sewu_history/" + currentEditIndex).update({
    status: document.getElementById("modalStatus").value,
    lunas: document.getElementById("modalLunas").value,
    ambil: document.getElementById("modalAmbil").value
  });
  closeModal();
}

function shareTransaksi() {
  if (currentEditIndex === null) return;
  db.ref("sewu_history/" + currentEditIndex).once("value").then(snap => {
    const t = snap.val();
    function formatWA(tanggal) { return tanggal ? tanggal.split('-').reverse().join('/') : "-"; }
    let updatedText = t.teksNota
      .replace(/Status\s*:\s*(Belum lunas|Lunas)/, `Status : ${t.status}`)
      .replace(/Dilunasi\s*:\s*-/, `Dilunasi : ${formatWA(t.lunas)}`)
      .replace(/Diambil\s*:\s*-/, `Diambil  : ${formatWA(t.ambil)}`);
    window.open(`https://wa.me/${t.nohp}?text=${encodeURIComponent(updatedText)}`, '_blank');
  });
}

function hapusTransaksi() {
  if (currentEditIndex === null || !confirm("Yakin hapus transaksi ini?")) return;
  db.ref("sewu_history/" + currentEditIndex).remove();
  closeModal();
}

// Load saat buka halaman
window.onload = function() {
  isiDatalistPelanggan();
  tampilkanHistory();
};
</script>
</body>
</html>

