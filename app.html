<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Sewu Laundry by Kostory</title>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
  <style>
    body{font-family:'Courier New',monospace;background:#f4f4f4;padding:20px;max-width:500px;margin:auto;}
    .form{background:white;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
    input,select{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:5px;box-sizing:border-box;}
    button{background:#25D366;color:white;padding:15px;width:100%;border:none;border-radius:5px;font-size:18px;cursor:pointer;margin-top:20px;}
    button:hover{background:#128C7E;}
    .history{margin-top:40px;background:white;padding:20px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1);}
    .history-item{padding:12px;border-bottom:1px solid #eee;cursor:pointer;}
    .btn-laporan{background:#FFB800 !important;color:#000 !important;font-weight:bold;}
    .logout{background:#e74c3c;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;}
    .modal-content{background:white;padding:25px;border-radius:12px;width:90%;max-width:420px;}
  </style>
</head>
<body>

<div class="form">
  <h2 style="text-align:center;">Sewu Laundry by Kostory</h2>
  <p style="text-align:center;">Selamat datang, <b><span id="userDisplay"></span></b>
    <button class="logout" style="padding:8px 15px;font-size:14px;width:auto;margin-left:10px;" onclick="keluar()">Keluar</button>
  </p>

  <label>Nama Konsumen</label>
  <input type="text" id="nama" list="pelangganList" placeholder="Ketik atau pilih nama" required/>
  <datalist id="pelangganList"></datalist>

  <label>No. HP (WhatsApp)</label>
  <input type="text" id="nohp" placeholder="628123456789" required/>

  <label>Kasir</label>
  <select id="kasir" required>
    <option value="Mekar">Mekar</option><option value="Satria">Satria</option><option value="Mitraya">Mitraya</option>
    <option value="Mitra">Mitra</option><option value="Ecokost">Ecokost</option><option value="Bukit">Bukit</option>
    <option value="Kanaya">Kanaya</option>
  </select>

  <label>Berat (kg)</label><input type="number" id="berat" value="8" min="1" required/>
  <label>Harga per kg</label><input type="number" id="harga" value="7000" required/>
  <label>Pewangi</label>
  <select id="pewangi"><option>Pxl</option><option>Mxl</option><option>Downy</option><option>Molto</option></select>
  <label>Diskon</label><input type="number" id="diskon" value="0"/>

  <button onclick="buatNota()">Buat Nota & Kirim WA</button>
  <pre id="preview" style="display:none;margin-top:20px;background:#fff;padding:15px;border:2px dashed #000;white-space:pre;"></pre>
</div>

<div class="history">
  <h3>Riwayat Transaksi</h3>
  <div id="historyList"><p style="text-align:center;color:#999;">Loading data...</p></div>
  <button class="btn-laporan" id="btnLaporan" onclick="cetakLaporan()" style="display:none;">Cetak Laporan Bulan Lalu</button>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <span onclick="closeModal()" style="float:right;font-size:30px;cursor:pointer;">×</span>
    <h3>Update Status</h3>
    <p><strong>No Nota:</strong> <span id="mNota"></span></p>
    <p><strong>Nama:</strong> <span id="mNama"></span></p>
    <label>Status</label><select id="mStatus"><option>Belum Lunas</option><option>Lunas</option></select>
    <label>Tanggal Lunas</label><input type="date" id="mLunas"/>
    <label>Tanggal Ambil</label><input type="date" id="mAmbil"/>
    <div style="text-align:center;margin-top:20px;">
      <button onclick="updateTransaksi()">Update</button>
      <button onclick="shareWA()">Share WA</button>
      <button style="background:#e74c3c;" onclick="hapusTransaksi()">Hapus</button>
    </div>
  </div>
</div>

<script>
// CONFIG FIREBASE (SUDAH PASTI BENAR)
const firebaseConfig = {
  apiKey: "AIzaSyCpTPqfkOCBv5_kMHtvtYjoGLfk3cDNuQ4",
  authDomain: "laundry-kostory.firebaseapp.com",
  databaseURL: "https://laundry-kostory-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "laundry-kostory",
  storageBucket: "laundry-kostory.firebasestorage.app",
  messagingSenderId: "264559624850",
  appId: "1:264559624850:web:f1a9ce75036bcffa4f5c4b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const user = localStorage.getItem("loggedUser");
if(!user) location.href="index.html";
document.getElementById("userDisplay").textContent = user==="admin"?"ADMIN":user.toUpperCase();
document.getElementById("btnLaporan").style.display = user==="admin"?"block":"none";

function keluar(){localStorage.removeItem("loggedUser");location.href="index.html";}

// PELANGGAN AUTO COMPLETE
function loadPelanggan(){
  db.ref("pelanggan").on("value", s=>{
    const data = s.val()||{};
    const list = document.getElementById("pelangganList");
    list.innerHTML="";
    Object.keys(data).forEach(n=> {
      const opt = document.createElement("option");
      opt.value = n;
      list.appendChild(opt);
    });
  });
}
document.getElementById("nama").addEventListener("input", ()=>{
  const n = document.getElementById("nama").value.trim();
  if(n) db.ref("pelanggan/"+n).once("value").then(s=> s.val() && (document.getElementById("nohp").value = s.val()));
});

// TAMPILKAN HISTORY (kasir hanya lihat punya sendiri)
let historyRef = user==="admin" ? db.ref("history") : db.ref("history").orderByChild("kasir").equalTo(user.charAt(0).toUpperCase()+user.slice(1));
historyRef.on("value", snap=>{
  const data = snap.val()||{};
  const arr = Object.keys(data).map(k=>{data[k].id=k; return data[k];});
  arr.sort((a,b)=>new Date(b.tanggal)-new Date(a.tanggal));
  const list = document.getElementById("historyList");
  list.innerHTML = arr.length===0 ? "<p style='text-align:center;color:#999;'>Belum ada transaksi</p>" : "";
  arr.forEach(t=>{
    const div = document.createElement("div");
    div.className="history-item";
    div.innerHTML = `${new Date(t.tanggal).toLocaleDateString("id-ID",{day:"numeric",month:"short",year:"2-digit"})} | ${t.nama} | ${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(t.total)} | ${t.status||"Belum Lunas"}`;
    div.onclick = ()=>bukaModal(t);
    list.appendChild(div);
  });
});

// BUAT NOTA
function buatNota(){
  const nama = document.getElementById("nama").value.trim() || "Pelanggan";
  const nohp = document.getElementById("nohp").value.trim();
  if(!nohp){alert("Nomor HP wajib!");return;}
  db.ref("pelanggan/"+nama).set(nohp);

  const kasir = document.getElementById("kasir").value;
  const berat = parseFloat(document.getElementById("berat").value);
  const harga = parseFloat(document.getElementById("harga").value);
  const pewangi = document.getElementById("pewangi").value;
  const diskon = parseFloat(document.getElementById("diskon").value)||0;
  const total = berat*harga - diskon;
  const sekarang = new Date();
  const bln = String(sekarang.getMonth()+1).padStart(2,"0");
  const tgl = String(sekarang.getDate()).padStart(2,"0");
  const urut = String((parseInt(localStorage.getItem("urut_"+tgl)||0)+1)).padStart(2,"0");
  localStorage.setItem("urut_"+tgl, parseInt(urut));
  const nota = bln+tgl+urut;

  const teksNota = `Sewu Laundry by Kostory
====================
Tanggal : ${sekarang.toLocaleString("id-ID")}
No Nota : ${nota}
Kostory : ${kasir}
Nama    : ${nama}
Berat   : ${berat} kg × ${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(harga)}
Diskon  : ${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(diskon)}
Total   : ${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR"}).format(total)}
Status  : ${total>0?"Belum Lunas":"Lunas"}
====================`;

  db.ref("history").push({
    nota, tanggal: sekarang.toISOString(), nama, total, status: total>0?"Belum Lunas":"Lunas",
    kasir, lunas:"", ambil:"", nohp, teksNota
  });

  document.getElementById("preview").textContent = teksNota;
  document.getElementById("preview").style.display = "block";
  open(`https://wa.me/${nohp}?text=${encodeURIComponent(teksNota)}`,"_blank");
}

// MODAL
let selected = null;
function bukaModal(t){
  selected = t.id;
  document.getElementById("mNota").textContent = t.nota;
  document.getElementById("mNama").textContent = t.nama;
  document.getElementById("mStatus").value = t.status || "Belum Lunas";
  document.getElementById("mLunas").value = t.lunas || "";
  document.getElementById("mAmbil").value = t.ambil || "";
  document.getElementById("editModal").style.display = "flex";
}
function closeModal(){document.getElementById("editModal").style.display="none";}
function updateTransaksi(){
  db.ref("history/"+selected).update({
    status: document.getElementById("mStatus").value,
    lunas: document.getElementById("mLunas").value,
    ambil: document.getElementById("mAmbil").value
  });
  closeModal();
}
function shareWA(){
  db.ref("history/"+selected).once("value").then(s=>{
    const t = s.val();
    let txt = t.teksNota.replace(/Status\s*:\s*.+/,`Status : ${t.status}`)
      .replace(/Dilunasi\s*:\s*-/,`Dilunasi : ${t.lunas||" - "}`)
      .replace(/Diambil\s*:\s*-/,`Diambil  : ${t.ambil||" - "}`);
    open(`https://wa.me/${t.nohp}?text=${encodeURIComponent(txt)}`,"_blank");
  });
}
function hapusTransaksi(){
  if(confirm("Yakin hapus transaksi ini?")) db.ref("history/"+selected).remove();
  closeModal();
}

// INIT
loadPelanggan();
</script>
</body>
</html>